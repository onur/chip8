<!DOCTYPE HTML>
<html lang="tr" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Emülasyon Döngüsü - Rust ile CHIP-8 Emülatörü Geliştirme</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded affix "><a href="giris.html">Rust ile CHIP-8 Emülatörü Geliştirme</a></li><li class="expanded affix "><a href="chip-8-hakkinda.html">CHIP-8 Hakkında</a></li><li class="expanded "><a href="baslangic.html"><strong aria-hidden="true">1.</strong> Başlangıç</a></li><li class="expanded "><a href="opcode-yapisi.html"><strong aria-hidden="true">2.</strong> Opcode Yapısı</a></li><li class="expanded "><a href="instruction-yapisi.html"><strong aria-hidden="true">3.</strong> Instruction Yapısı</a></li><li class="expanded "><a href="emulator-yapisi.html"><strong aria-hidden="true">4.</strong> Emülatör Yapısı</a></li><li><ol class="section"><li class="expanded "><a href="rom-okunmasi.html"><strong aria-hidden="true">4.1.</strong> ROM Okunması</a></li><li class="expanded "><a href="instructionlarin-alinmasi.html"><strong aria-hidden="true">4.2.</strong> Instruction'ların Alınması</a></li><li class="expanded "><a href="instructionlarin-calistirilmasi.html"><strong aria-hidden="true">4.3.</strong> Instruction'ların Çalıştırılması</a></li></ol></li><li class="expanded "><a href="goruntu-yapisi.html"><strong aria-hidden="true">5.</strong> Görüntü Yapısı</a></li><li class="expanded "><a href="klavye-yapisi.html"><strong aria-hidden="true">6.</strong> Klayve Yapısı</a></li><li class="expanded "><a href="emulasyon-dongusu.html" class="active"><strong aria-hidden="true">7.</strong> Emülasyon Döngüsü</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Rust ile CHIP-8 Emülatörü Geliştirme</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                            <a href="https://github.com/onur/chip8" title="Git repository" aria-label="Git repository">
                                <i id="git-repository-button" class="fa fa-github"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#emülasyon-döngüsü" id="emülasyon-döngüsü">Emülasyon Döngüsü</a></h1>
<p>Tüm bileşenleri yazdığımıza göre artık emülasyon döngüsünü kurabiliriz.
Öncelikle gerekli kullanımları yapalım:</p>
<pre><code class="language-rust no_run noplaypen">use std::thread::sleep;
use std::time::Duration;
</code></pre>
<p>CHIP-8 oyunları kendi işlemci hızında çalışabilecek şekilde
programlandığından, modern bir işlemcide çok hızlı çalışacaktır. Bu
problemi her bir instructiondan sonra belirli bir süre bekleyerek
çözebiliriz. Çalışan thread'ımızda hiç bir şey yapmadan bekleyebileceğimiz
<code>sleep</code> fonksiyonunu modülümüze ekledik.</p>
<p>Ardıdan emülasyon metodunu <code>impl Emulator</code> bloğu içerisine oluşturalım:</p>
<pre><code class="language-rust no_run noplaypen">    pub fn emulate(&amp;mut self) {
        while self.display.is_open() {
            self.display.as_mut().update();

            if let Some(keys) = self.display.as_mut().get_keys() {
                keys.iter().for_each(|key| self.keyboard.press_key(*key));
                if keys.is_empty() {
                    self.keyboard.release_key();
                }
            }

            let instruction = self.instruction_oku().expect(&quot;Bilinmeyen Instruction&quot;);
            self.instruction_calistir(instruction);

            if self.delay_timer &gt; 0 {
                self.delay_timer -= 1;
            }

            if self.sound_timer &gt; 0 {
                if self.sound_timer == 1 {
                    println!(&quot;BEEP!&quot;);
                }
                self.sound_timer -= 1;
            }

            sleep(Duration::from_millis(5));
        }
    }
</code></pre>
<p>Döngümüz pencere açık olduğu süre boyunca çalışacak.</p>
<p><code>Display</code> tipine eklemiş olduğumuz ve referanstan-referansa dönüştürme
işlemi yapan <code>AsMut</code> özelliği sayesinde, <code>self.display.as_mut()</code> diyerek,
pencere yapısına ulaşabiliyoruz. minifb'de yer alan
<a href="https://docs.rs/minifb/0.13.0/minifb/struct.Window.html#method.update"><code>update()</code></a>
metodu, çizim yapmasak bile basılan tuşları alabilmemiz için çalıştırmamız
gereken bir metod.</p>
<pre><code class="language-rust no_run noplaypen">            if let Some(keys) = self.display.as_mut().get_keys() {
                keys.iter().for_each(|key| self.keyboard.press_key(*key));
                if keys.is_empty() {
                    self.keyboard.release_key();
                }
            }

            let instruction = self.instruction_oku().expect(&quot;Bilinmeyen Instruction&quot;);
            self.instruction_calistir(instruction);

            if self.delay_timer &gt; 0 {
                self.delay_timer -= 1;
            }

            if self.sound_timer &gt; 0 {
                if self.sound_timer == 1 {
                    println!(&quot;BEEP!&quot;);
                }
                self.sound_timer -= 1;
            }

            sleep(Duration::from_millis(5));
        }
    }
}
</code></pre>
<p>Burada penceremizden basılan tuşların bir listesini alıyoruz. Bu fonksiyon
<code>Option</code> dönen bir fonksiyon olduğundan, Rust'a ait <code>if let</code> sözdizimini
kullanabiliriz. Bu if bloğu sadece <code>self.display.as_mut().get_keys()</code>
metodu <code>Some</code> döndüğünde çalışır. Ardından klavye alanına basılan tuşu
aktarıyoruz. <code>get_keys()</code> metodunun boş dönmesi durumunda basılan tuşu
geri bırakmak için klavye yapımızda kullandığımız <code>release_key()</code> metodunun
çalıştırıyoruz.</p>
<pre><code class="language-rust no_run noplaypen">            let instruction = self.instruction_oku().expect(&quot;Bilinmeyen Instruction&quot;);
            self.instruction_calistir(instruction);
</code></pre>
<p>Daha önce yazdığımız instructionların okunması ve çalıştırılması işlemi
burada gerçekleştiriliyor. <code>expect()</code> metodu <code>Option</code> dönen
<code>instruction_oku()</code> metodundan <code>None</code> dönülmesi durumunda, &quot;Bilinmeyen
Instruction&quot; hata mesajıyla birlikte panikleyip çıkmamızı sağlıyor.</p>
<pre><code class="language-rust no_run noplaypen">            if self.delay_timer &gt; 0 {
                self.delay_timer -= 1;
            }

            if self.sound_timer &gt; 0 {
                if self.sound_timer == 1 {
                    println!(&quot;BEEP!&quot;);
                }
                self.sound_timer -= 1;
            }

            sleep(Duration::from_millis(5));
</code></pre>
<p>Son olarak CHIP-8'in timerlarını birer sayı azaltıp, her instructiondan
sonra 5 mili saniye bekleyerek döngümüzü tamamlıyoruz. Herhangi bir ses
arabirimi kullanmadığımızdan, ses için şimdilik ekrana &quot;BEEP!&quot; mesajını
yazdırıyoruz. İsterseniz siz bir ses paketi kullanarak bilgisayardan ses
çıkmasını da sağlayabilirsiniz.</p>
<h2><a class="header" href="#main-fonksiyonu" id="main-fonksiyonu"><code>main()</code> fonksiyonu</a></h2>
<p>Artik emülatörümüz tüm bileşenleriyle hazır. Tek yapmamız gereken program
başladığında çalışacak olan <code>main</code> fonksiyonunu tanımlamak. Bunun için
program çalıştığında, program argümanlarını almamıza yarayacak
<code>std::env::args</code> fonksiyonunu dahil edelim ve main fonksiyonumuzu yazalım:</p>
<pre><code class="language-rust no_run noplaypen">use std::env::args;

fn main() {
    Emulator::new()
        .rom_oku(args().nth(1).unwrap_or_else(|| &quot;brix.ch8&quot;.to_string()))
        .expect(&quot;ROM okurken hata oluştu&quot;)
        .emulate();
}
</code></pre>
<p><code>args().nth(1).unwrap_or_else(|| &quot;brix.ch8&quot;.to_string())</code> söz dizimi,
program argümanlarından ilkini almaya ve eğer herhangi bir argüman
girilmezse de varsayılan olarak <code>brix.ch8</code> stringini dönmeye yarıyor. Bu
sayede emülatörümüz istenildiği taktirde farklı bir ROM'u oynatabilir.
<code>args()</code> fonksiyonu <code>String</code> cinsinden değerler döndüğü için
<code>&quot;brix.ch8&quot;</code>'in de <code>String</code>'e dönüştürülmesi gerekli. Bu işlem için
<code>to_string()</code> metodunu kullandık.</p>
<p>Eğer hatırlarsanız <code>rom_oku()</code> metodunu yazarken instance sahipliğini
almıştık ve dönüş değeri olarak yine almış olduğumuz sahipliği dönmüştük.
Bu sayede <code>expect()</code> ile hatadan kurtarılan instance'a <code>emulate()</code> metodunu
zincir halinde kullanabiliyoruz.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="klavye-yapisi.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="klavye-yapisi.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
